<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>j96753@GMAIL.COM</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }

        #map {
            height: 100%;
            width: 100%;
        }

         #delete, #export, #export2  {

		            position: absolute;
		            bottom:80px;
		            right:25px;
		            z-index:900;
		            background:orangered;
		            color:yellow;
		            padding:7px;
		            border-radius:10px;
		            font-family: 'Helvetica Neue';
		            cursor: pointer;
		            font-size:20px;
		            text-decoration:none;
		        }
		        #export {
		            bottom:120px;

        }
                 #export2 {
                     bottom:160px;

        }



    </style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" />
<script src="L.Control.MousePosition.js"></script>
<link rel="stylesheet" href="L.Control.MousePosition.css" />
<script src="script-kml.js"></script>
<script src="insert_kml_nws.js"></script>
<script src="insert_kml_windninja.js"></script>
<link rel="stylesheet" href="Leaflet.PolylineMeasure.css" />
<script src="Leaflet.PolylineMeasure.js"></script>
<script src="leaflet-heat.js"></script>
<script src="f_heatpoints.js"></script>
<script src="https://unpkg.com/catiline@2.9.3/dist/catiline.js"></script>
<script src="leaflet.shpfile.js"></script>
<script src="shp.js"></script>
<link rel="stylesheet" href="leaflet-velocity.css" />
<script src="leaflet-velocity.js"></script>
<script src="https://unpkg.com/proj4"></script>
<script src="https://unpkg.com/georaster"></script>
<script src="https://unpkg.com/georaster-layer-for-leaflet"></script>
<script src="https://unpkg.com/chroma-js"></script>
<script src="https://unpkg.com/geoblaze"></script>
<script src="https://unpkg.com/@ngageoint/leaflet-geopackage@4.1.3/dist/leaflet-geopackage.min.js"></script>

 <!--Add draw plugin -->
    <link rel='stylesheet' href='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.css' />
    <script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.js'></script>

<!--Add mapbox building street layer -->

<link href="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.js"></script>


</head>

<body>

<div id="map"></div>

    <div id='delete'>feature rm</div>
    <a href='#' id='export'>ignition fx</a>
    <a href='#' id='export2'>landfire fx</a>

<script>

// Add OpenStreetMap
// https://b.tile.openstreetmap.fr/hot/${z}/${x}/${y}.png

let osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a>'
});

// Add Caltopo Service LIDAR

 let caltopo_lidar = L.tileLayer('http://caltopo.com/api/0GMF5F/wmts/tile/r/{z}/{x}/{y}.png', {
             maxZoom: 19

});


// Try Map Box with MapStudio Style code
// pk.eyJ1Ijoiem1jYWxlcnQiLCJhIjoiY2xjemJrY3BoMHJwYjN1b2RneXNzYjg4YiJ9._Wq8Oj7aQYYIfSc2YaHpRg
// cld0g4r7s000914n7vhatmacs

let mapbox = L.tileLayer('https://api.mapbox.com/styles/v1/zmcalert/cld0g4r7s000914n7vhatmacs/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1Ijoiem1jYWxlcnQiLCJhIjoiY2xjemJrY3BoMHJwYjN1b2RneXNzYjg4YiJ9._Wq8Oj7aQYYIfSc2YaHpRg', {
    Zoom: 8,
    attribution: '&copy; <a href="http://mapbox.com">MapBox</a>'
});


//End Map Box


// Wildland Fire Assessment System WFAS
// Add WMS layer for Severe Fire Weather Potential Index layer: fbxday0,fbxday1,fbxday2

let wfas_0 = L.tileLayer.wms('https://www.wfas.net/cgi-bin/mapserv?map=/var/www/html/nfdr/mapfiles/wfas_wms_new.map', {
        layers: 'fbxday0',
        format:"image/png",
        transparent:"true",
        opacity:"0.60"

});


// End WFAS

// BEGIN firedanger.cr.usgs.gov
// Add WMS layer for Operational Fire Danger Forecast Products: 1_conus_day, 2_conus_day, 3_conus_day


let wfpi_1 = L.tileLayer.wms('https://dmsdata.cr.usgs.gov/geoserver/firedanger_emodis-wfpi-forecast-1_conus_day_data/ows?SERVICE=WMS', {
        layers: 'emodis-wfpi-forecast-1_conus_day_data',
        format: "image/png",
        transparent:"true",
		opacity:"0.60"
});

// END firedanger.cr.usgs.gov

// Start Landfire Fuels -  FBFM40

let lf_f40 = L.tileLayer.wms('https://edcintl.cr.usgs.gov/geoserver/landfire/us_220/ows?service=WMS', {
        layers: 'LC22_F40_220',
        format: "image/png",
        transparent:"true",
		opacity:"0.60"
});

// END Landfire


// Get 24 Hour VIIRS

console.log("Load VIIRS");

f_heatPoints = f_heatPoints.map(function (p) { return [p[0], p[1]]; });

 var f_heat = L.heatLayer(f_heatPoints,{
            minOpacity: .8,
            radius: 8,
            blur: 8,
            maxZoom: 18,
        });

console.log("END VIIRS");

// END VIIRS

// Add Fire Spread Model

console.log("Load ELM Shape");

var elmstyle = {
"color": "orange",
"weight": .2,
"opacity": .8
};

    var elmShp = new L.Shapefile('ig_spread',{
	style: elmstyle,

            onEachFeature: function(feature, layer) {
                if (feature.properties) {
                    layer.bindPopup(Object.keys(feature.properties).map(function(k) {
                        return k + ": " + feature.properties[k];
                    }).join("<br />"), {
                        maxHeight: 200
                    });
                }
            }
        });

        elmShp.once("data:loaded", function() {
        console.log("END ELM Shape");

        });

//  END Elm shape file


// ADD Building IG  ASSETS

console.log("Load Build Shape");

var buildShp = new L.Shapefile('ig_building', {
			pointToLayer: function(feature, latlng) {
					  return L.circle(latlng, 20);
					  },
 	 	  style: {color: "red", weight: .5, fillopacity:.1},
			onEachFeature: function(feature, layer) {
				if (feature.properties) {
					layer.bindPopup(Object.keys(feature.properties).map(function(k) {
						return k + ": " + feature.properties[k];
					}).join("<br />"), {
						maxHeight: 200
					});
				}
			}
		});
		buildShp.once("data:loaded", function() {
			console.log("END Build Shape");
		});

// END Building ASSETS

// ADD FLAM IG PT

console.log("Load IG Shape");

var igShp = new L.Shapefile('ig_geo', {
			pointToLayer: function(feature, latlng) {
					  return L.circle(latlng, 50);
					  },
 	 	  style: {color: "orangered"},
			onEachFeature: function(feature, layer) {
				if (feature.properties) {
					layer.bindPopup(Object.keys(feature.properties).map(function(k) {
						return k + ": " + feature.properties[k];
					}).join("<br />"), {
						maxHeight: 200
					});
				}
			}
		});
		igShp.once("data:loaded", function() {
			console.log("END IG Shape");
		});

// END FLAM IG PT

// ADD FLAM Bounds - FLAMMAP NINJA IG

console.log("Load DOMAIN Shape");

var domainstyle = {
"color": "red",
"weight": .1,
"opacity": .1
};

    var domainShp = new L.Shapefile('clip',{
	style: domainstyle,

            onEachFeature: function(feature, layer) {
                if (feature.properties) {
                    layer.bindPopup(Object.keys(feature.properties).map(function(k) {
                        return k + ": " + feature.properties[k];
                    }).join("<br />"), {
                        maxHeight: 200
                    });
                }
            }

        });

        domainShp.once("data:loaded", function() {
        console.log("END DOMAIN Shape");

        });


console.log("END DOMAIN Shape");


// END FLAM Bounds

// Begin AJAX Placeholder


fire16 = L.layerGroup();
elmfire = L.layerGroup();
smoke = L.layerGroup();
gWind4 = L.layerGroup();
irwin2 = L.layerGroup();
irwin_p2 = L.layerGroup();

// END AJAX placeholder


// Begin BASE MAPS

var baseMaps = {

   "OpenStreetMap": osm,


};

var overlayMaps = {

    "Mapbox": mapbox,
    "GOES16 Fire": fire16,
    "LIDAR": caltopo_lidar,
    "LandFire Fuel": lf_f40,
    "HRRR Index": smoke,
    "USGS Index": wfpi_1,
    "USFS Index": wfas_0,
    "FLAM Bounds": domainShp,
    "FLAM IG": igShp,
    "FLAM Build": buildShp,
    "FLAM Spread": elmShp,
    "FLAM Time": elmfire,
    "NWS RedFlag": poly_nws,
	"IRWIN pt": irwin2,
    "IRWIN Pl": irwin_p2,
    "NINJA": ninja,
    "VIIRS": f_heat,
    "Velocity": gWind4

};

// Begin VAR MAPS

// Begin CONTROLS
// Lebanon Kansas Center 39.8097° N, 98.5556° W

var map = L.map('map', {

center: [39.8097, -98.5556] ,
zoom: 5,

layers: [mapbox, elmfire, igShp, gWind4]

});

// END VAR MAPS

L.control.mousePosition().addTo(map);

L.control.layers(baseMaps, overlayMaps).addTo(map);

// Zoom to Bounds

var group = new L.featureGroup();
domainShp.addTo(group);
setTimeout(function(){ console.log("CHECK THIS MAPEXTENT");map.flyToBounds(group.getBounds({duration: 2000}));}, 6000);

// END CONTROLS


// Begin Velocity Layer

// RTMA rapid refresh 3k wind - 10 meters from ground
console.log("Get RTMA Wind");

 $.getJSON("rtma-geo.json", function(data) {
 	  var velocityLayer4 = L.velocityLayer({
 	    displayValues: true,
 	    displayOptions: {
 	    velocityType: "",
 	    displayPosition: "bottomleft",
 	    displayEmptyString: "No wind data",
        speedUnit: "mph",
        angleConvention: "meteo"

 	    },
 	    data: data,
 	    minVelocity: 1,
 	    maxVelocity: 20,
 	    colorScale: ["#2468b4", "#3c9dc2", "#80cdc1", "#97daa8", "#c6e7b5", "#eef7d9", "#ffee9f", "#fcd97d", "#ffb664", "#fc964b", "#fa7034", "#f54020", "#ed2d1c", "#dc1820", "#b40023"],
 	    velocityScale: 0.009,
        opacity: 1.0,
        paneName: "overlayPane"

  });

gWind4.addLayer(velocityLayer4);

  });


// END Velocity Layer


console.log("Start IRWIN PT");

// IRWIN NIFC PT

var irwin = $.ajax({
            url: "https://services3.arcgis.com/T4QMspbfLg3qTGWY/arcgis/rest/services/Current_WildlandFire_Locations/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson",
            dataType: "json",
            success: console.log("Get IRWIN PT AJAX"),
            error: function(xhr) {
                alert(xhr.statusText)
            }
        })

        $.when(irwin).done(function() {

        function onEachFeature7(feature, layer){

			   layer.bindTooltip(

			    'objectid: ' + feature.properties.OBJECTID + '<br>'
			   + 'firediscovery: ' + new Date(feature.properties.FireDiscoveryDateTime) + '<br>'
			   + 'name: ' + feature.properties.IncidentName + '<br>'
			   + 'category: ' + feature.properties.IncidentTypeCategory + '<br>'
			   + 'agency: ' + feature.properties.POOJurisdictionalAgency + '<br>'
			   + 'description: ' + feature.properties.IncidentShortDescription + '<br>'
               + '% contained: ' + feature.properties.PercentContained + '<br>'
               + 'Acres Calc: ' + feature.properties.CalculatedAcres + '<br>'
   		       + 'fireout: ' + feature.properties.FireOutDateTime)};

			   var irwin1 = L.geoJson(irwin.responseJSON, {
			                pointToLayer: function(feature, latlng) {
						    return L.circle(latlng, 1500);
						    },
 	 	                    style: {color: "orange", weight: 4,},
			                onEachFeature: onEachFeature7

			});

			    irwin2.addLayer(irwin1);
			});


console.log("END IRWIN AJAX");

console.log("Start IRWIN Poly");

// IRWIN NIFC Poly

var irwin_p = $.ajax({
            url: "https://services3.arcgis.com/T4QMspbfLg3qTGWY/arcgis/rest/services/Current_WildlandFire_Perimeters/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson",
            dataType: "json",
            success: console.log("Get IRWIN Poly AJAX"),
            error: function(xhr) {
                alert(xhr.statusText)
            }
        })

        $.when(irwin_p).done(function() {

        function onEachFeature8(feature, layer){

               layer.bindTooltip(

			    'name: ' + feature.properties.irwin_IncidentName + '<br>'
   		       + 'dailyacres: ' + feature.properties.irwin_DailyAcres)};

               var irwin_p1 = L.geoJson(irwin_p.responseJSON, {
 	 	                    style: {color: "red", weight: 2,},
			                onEachFeature: onEachFeature8

			});

			    irwin_p2.addLayer(irwin_p1);
			});

console.log("END IRWIN poly");


// ELM Raster

console.log("Start ELM raster");

map.createPane('elm');
map.getPane('elm').style.zIndex = 225;
map.getPane('elm').style.pointerEvents = 'none';

let elmfire1 = "http://localhost:1337/time-of-arrival.tif";

         fetch(elmfire1)
        .then(response => response.arrayBuffer())
        .then(arrayBuffer => {

         parseGeoraster(arrayBuffer).then(georaster => {

          const min = georaster.mins[0];
          const max = georaster.maxs[0];
          const range = georaster.ranges[0];

          console.log("georaster:", georaster);
          console.log(chroma.brewer);
          var scale = chroma.scale("Spectral");

            var elmfire2 = new GeoRasterLayer({
            attribution: "zmc.alert@gmail.com",
            georaster: georaster,
            debugLevel: 1,
            resolution: 1024,
            resampleMethod: "bilinear" ,
            rgb: "false",
            project: "true",
            opacity: .6,
            pane: 'elm',

             pixelValuesToColorFn: function(pixelValues) {
                  var pixelValue = pixelValues[0]; // there's just one band in this raster

                  // if there's zero wind, don't return a color
                  if (pixelValue === -9999) return null;

                  // scale to 0 - 1 used by chroma
                  var scaledPixelValue = (pixelValue - min) / range;

                  var color = scale(scaledPixelValue).hex();

                  return color;
}

   });

     elmfire2.addTo(elmfire);

     // Fire Threat Geoblaze ID

		 map.on('click', function(evt) {
	 	 var latlng = map.mouseEventToLatLng(evt.originalEvent);
	 	 console.log('Fire Threat Minutes: ' + geoblaze.identify(georaster, [latlng.lng, latlng.lat]));
	 });

	 // End Geoblaze ID

  });

 });

console.log("END ELM raster");

// ELM Raster

console.log("Start SMOKE raster");

map.createPane('smoke');
map.getPane('smoke').style.zIndex = 300;
map.getPane('smoke').style.pointerEvents = 'none';

let smoke1 = "http://localhost:1337/smoke.tif";

         fetch(smoke1)
        .then(response => response.arrayBuffer())
        .then(arrayBuffer => {

         parseGeoraster(arrayBuffer).then(georaster => {

          const min = georaster.mins[0];
          const max = georaster.maxs[0];
          const range = georaster.ranges[0];

          console.log("georaster:", georaster);
          console.log(chroma.brewer);

          var scale = chroma.scale(['#0082ff','#00b9ff','#00eaff','#71e300','#b8ff39','#ffce01','#ffbb0f','#ff6c04','#ff2c00','#ff00e3','#f4b7f5']).domain([0,1]);

           var smoke2 = new GeoRasterLayer({
            attribution: "zmc.alert@gmail.com",
            georaster: georaster,
            debugLevel: 1,
            resolution: 1024,
            resampleMethod:"bilinear" ,
            rgb: "false",
            project: "true",
            opacity: 0.6,
            pane: 'smoke',

             pixelValuesToColorFn: function(pixelValues) {
                  var pixelValue = pixelValues[0]; // there's just one band in this raster

                  // if there's zero wind, don't return a color
                  if (pixelValue === 0) return null;

                  // scale to 0 - 1 used by chroma
                  var scaledPixelValue = (pixelValue - min) / range;

                  var color = scale(scaledPixelValue).hex();

                  return color;
}

   });

     smoke2.addTo(smoke);


  });

 });

console.log("END SMOKE raster");


// Add Fire-Recipe GOES16

console.log("Start Fire-Recipe GOES16");

map.getPane('tilePane').style.zIndex = 225;
map.getPane('tilePane').style.pointerEvents = 'none';

let fire16_1 = "http://localhost:1337/16-crop.tif";

         fetch(fire16_1)
        .then(response => response.arrayBuffer())
        .then(arrayBuffer => {

         parseGeoraster(arrayBuffer).then(georaster => {

           var fire16_2 = new GeoRasterLayer({
            attribution: "zmc.alert@gmail.com",
            georaster: georaster,
            resolution: 1024,
            project: "true",
            opacity: 1,
            pane: 'tilePane',

});

     fire16_2.addTo(fire16);


  });

     });

console.log("END GOES16 raster");


// Add Tools

let polylineMeasure = L.control.polylineMeasure ({position:'topleft', unit:'metres', showBearings:true, clearMeasurementsOnStop: false, showClearControl: true, showUnitControl: true})
            polylineMeasure.addTo (map);

            function debugevent(e) { console.debug(e.type, e, polylineMeasure._currentLine) }

            map.on('polylinemeasure:toggle', debugevent);
            map.on('polylinemeasure:start', debugevent);
            map.on('polylinemeasure:resume', debugevent);
            map.on('polylinemeasure:finish', debugevent);
            map.on('polylinemeasure:clear', debugevent);
            map.on('polylinemeasure:add', debugevent);
            map.on('polylinemeasure:insert', debugevent);
            map.on('polylinemeasure:move', debugevent);
            map.on('polylinemeasure:remove', debugevent);


// Add Leaflet draw export fire points

 var featureGroup = L.featureGroup().addTo(map);

        var drawControl = new L.Control.Draw({
            edit: {
                featureGroup: featureGroup
            }
        }).addTo(map);

        map.on('draw:created', function(e) {

            // Each time a feaute is created, it's added to the over arching feature group
            featureGroup.addLayer(e.layer);
        });


        // on click, clear all layers
        document.getElementById('delete').onclick = function(e) {
            featureGroup.clearLayers();
        }

        document.getElementById('export').onclick = function(e) {
            // Extract GeoJson from featureGroup
            var data = featureGroup.toGeoJSON();

            // Stringify the GeoJson
            var convertedData = 'text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(data));

            // Create export
            document.getElementById('export').setAttribute('href', 'data:' + convertedData);
            document.getElementById('export').setAttribute('download','pt_geo.geojson');
        }

         document.getElementById('export2').onclick = function(e) {
            // Extract GeoJson from featureGroup
            var data = featureGroup.toGeoJSON();

            // Stringify the GeoJson
            var convertedData = 'text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(data));

            // Create export
            document.getElementById('export2').setAttribute('href', 'data:' + convertedData);
            document.getElementById('export2').setAttribute('download','poly_geo.geojson');
        }


// End Leaflet draw


// Add Watermarks bottom Left

L.Control.Watermark = L.Control.extend({
		onAdd: function(map) {
			var img = L.DomUtil.create('img');

			img.src = 'ninja2.bmp';
			img.style.width = '140px';

			return img;
		},

		onRemove: function(map) {
			// Nothing to do here
		}
	});

	L.control.watermark = function(opts) {
		return new L.Control.Watermark(opts);
	}

//	L.control.watermark({ position: 'bottomleft' }).addTo(map);

// Add Watermarks Bottom Left

	L.Control.Watermark = L.Control.extend({
			onAdd: function(map) {
				var img = L.DomUtil.create('img');

				img.src = 'ninja1.bmp';
				img.style.width = '140px';

				return img;
			},

			onRemove: function(map) {
				// Nothing to do here
			}
		});

		L.control.watermark = function(opts) {
			return new L.Control.Watermark(opts);
		}

		L.control.watermark({ position: 'bottomleft' }).addTo(map);


// Add Watermarks Bottom Right

			L.Control.Watermark = L.Control.extend({
					onAdd: function(map) {
						var img = L.DomUtil.create('img');

						img.src = 'firelogo.png';
						img.style.width = '70px';


						return img;
					},

					onRemove: function(map) {
						// Nothing to do here
					}
				});

				L.control.watermark = function(opts) {
					return new L.Control.Watermark(opts);
				}

				L.control.watermark({ position: 'bottomright' }).addTo(map);

        </script>

          <p ALIGN=CENTER> <B><i>Landfire Fuels - 40 Scott and Burgan Fire Behavior Fuel Model </b></i> </p>

        <div style="text-align: left;"><img src="landfire-legend.png" width="100%" /></div>

          <p ALIGN=CENTER><B><i> HRRR Hourly Wildfire Potential Index %  </b></i> </p>

        <div style="text-align: left;"><img src="hrrr-legend.png" width="100%" /></div>

         <p ALIGN=CENTER><B><i> USGS Wildfire Potential Index - Daily Vegetation Flammability </b></i> </p>

        <div style="text-align: left;"><img src="usgs-legend.png" width="100%" /></div>

            <p ALIGN=CENTER><B><i> USFS Wildland Fire Assessment System - Daily Severe Fire Weather Potential </b></i> </p>

        <div style="text-align: left;"><img src="wfas-legend.png" width="100%" /></div>

</body>
</html>
